# Attribution Engine – Data & API Spec (v1.0)

This document defines the database schema for the multi-tenant ledger and the protocols for Ingestion (Write) and Intelligence (Read).

---

## 1. Core Data Model

The database is designed for high-write volume and immutable audit logs.

### `tenants`
The customers using the engine (e.g., "Moreways Site", "LawFirm A").
*   `id` (UUID, PK)
*   `name` (String)
*   `public_key` (String, `pk_...`) – Exposed in the JS Pixel. Write-only permission.
*   `secret_key` (String, `sk_...`) – Backend Admin key. Read/Write permission.
*   `ad_config` (JSONB, Encrypted) – Stores sensitive external credentials.
    *   `{ "meta_pixel_id": "...", "meta_access_token": "...", "google_conv_id": "..." }`
*   `webhook_url` (String, nullable) – Endpoint to push processed leads back to the client.

### `identities` (The Graph)
Links browser sessions (Anonymous) to CRM entities (Known Users).
*   `id` (UUID, PK)
*   `tenant_id` (FK)
*   `anonymous_id` (String) – The persistent UUID v4 generated by the Pixel.
*   `user_id` (String, nullable) – The external CRM ID (e.g., email hash or DB UUID).
*   `created_at` (Timestamp)
*   `last_seen_at` (Timestamp)

### `events` (The Ledger)
The immutable stream of all actions. **This is the Source of Truth.**
*   `id` (UUID, PK)
*   `tenant_id` (FK)
*   `identity_id` (FK)
*   `event_type` (Enum: `pageview`, `lead`, `purchase`, `custom`)
*   `consent_policy` (JSONB) – **CRITICAL.** Defines legal usage rights.
    *   `{ "ad_storage": "granted" | "denied", "analytics_storage": "granted" | "denied" }`
*   `context_client` (JSONB) – Device fingerprints.
    *   `{ "user_agent": "...", "ip_hash": "sha256(...)", "locale": "en-US" }`
*   `context_cookies` (JSONB) – The "Cookie Bridge" data.
    *   `{ "_fbp": "fb.1.123...", "_fbc": "...", "_gcl_au": "..." }`
*   `click_data` (JSONB) – The Ad Identifiers.
    *   `{ "gclid": "...", "fbclid": "...", "ttclid": "..." }`
*   `metadata` (JSONB) – Custom payload (e.g., `value: 100`, `currency: USD`).
*   `processing_status` (JSONB) – Audit trail for Dispatcher.
    *   `{ "meta_capi": "sent", "google_ads": "skipped_consent", "linkedin": "failed_retry" }`

---

## 2. Ingestion API Contract (Write)

### Endpoint: `POST /api/v1/track`
The high-volume endpoint utilized by the Pixel. It supports direct browser calls and server-side proxied calls.

**Headers:**
*   `Content-Type`: `application/json`
*   `x-publishable-key`: `pk_mw_12345` (Required)
*   `x-forwarded-for`: (Required if proxied, to capture the real user IP)
*   `user-agent`: (Required if proxied, to capture the real device)

**Request Body (The "Titanium" Payload):**
```json
{
  "type": "lead",
  "anonymousId": "anon_8823_xyz",
  "timestamp": "2023-10-27T10:00:00Z",
  
  "consent": {
    "ad_storage": "granted",
    "analytics_storage": "granted"
  },
  
  "context": {
    "url": "https://moreways.io/claim/123",
    "referrer": "https://google.com",
    "title": "Start Claim"
  },
  
  "click": {
    "gclid": "Test_123",
    "fbclid": "IwAR0..."
  },
  
  "cookies": {
    "_fbp": "fb.1.169...",
    "_fbc": "fb.1.169...",
    "_li_fat_id": "..."
  },
  
  "user": {
    "email_hash": "a6s5d4...", 
    "phone_hash": "88d7s..."
  },
  
  "data": {
    "value": 150.00,
    "currency": "USD",
    "lead_source": "web_form"
  }
}
```

**Responses:**
*   **200 OK:** `{ "success": true, "eventId": "evt_123" }` (Accepted for processing).
*   **401 Unauthorized:** Invalid API Key.
*   **429 Too Many Requests:** Rate limit exceeded.

---

## 3. Intelligence API Contract (Read)

### Endpoint: `GET /api/v1/journey/:userId`
Used by the Admin CRM to visualize the user's touchpoints.

**Headers:**
*   `Authorization`: `Bearer sk_mw_secret_key` (Admin only)

**Response:**
```json
{
  "user_id": "user_555",
  "first_seen": "2023-10-01T08:00:00Z",
  "attribution_model": "linear",
  "touchpoints": [
    { 
      "timestamp": "2023-10-01T08:00:00Z",
      "source": "google", 
      "medium": "cpc", 
      "campaign": "fall_acquisition",
      "weight": 0.4 
    },
    { 
      "timestamp": "2023-10-05T12:00:00Z",
      "source": "facebook", 
      "medium": "retargeting", 
      "campaign": "video_testimonial",
      "weight": 0.4 
    },
    { 
      "timestamp": "2023-10-06T09:00:00Z",
      "source": "direct", 
      "medium": "none", 
      "weight": 0.2 
    }
  ]
}
```

### Endpoint: `GET /api/v1/audit/:eventId`
Used to audit specific data sharing compliance.

**Response:**
```json
{
  "event_id": "evt_123",
  "consent_snapshot": { "ad_storage": "denied" },
  "dispatch_logs": [
    { "destination": "internal_db", "status": "success", "timestamp": "..." },
    { "destination": "meta_capi", "status": "blocked", "reason": "consent_denied" }
  ]
}
